#!/usr/bin/env node
var esprima = require("esprima"),
    sniffer = require('./lib/Sniffer'),
    util = require('./lib/Util'),
    Standard,
    fs = require('fs'),
    path,
    options = {},
    helpScreen = "Usage: jscs <path>\n" +
                    "<path> - filename or dir to sniff\n" +
                    "[--standard=<Standard>] - apply specified standard (Idiomatic, Jquery)\n" +
                    "[--trace] - show tokens\n",

    processFile = function( path, fn ) {
            var data = fs.readFileSync( path, 'utf-8' );
                    fn( path, data );
    },
    processDir = function( path, fn ) {
            var dir = fs.readdirSync( path );
            dir && dir.forEach(function( file ){
                    var re = /\.js$/gi;
                    if ( re.test( file ) ) {
                            processFile( path + "/" + file, fn );
                    }
            });
    },
    processPath = function( path, fn ) {
            var stat;
            if (  !fs.existsSync( path ) ) {
                    return console.error( helpScreen );
            }
            stat = fs.statSync( path );
            return stat.isFile() ? processFile( path, fn ) : processDir( path, fn );
    };

if ( process.argv.length < 3 ) {
    return console.log( helpScreen );
}
// Obtain CLI arguments
process.argv.slice( 2 ).forEach(function( arg ){
    var slices;
    if ( arg === "--help" ) {
            return console.log( helpScreen );
    }
    if ( arg.indexOf( "--" ) === 0 ) {
            slices = arg.split( "=" );
            options[ slices[0] ] = slices[ 1 ] || null;
    } else {
            path = arg;
    }
});


// Get standard sniffs
options["--standard"] = options["--standard"] || "Idiomatic";
try {
    Standard = require('./standard/' + options["--standard"]);
} catch ( e ) {
    if ( e.code !==  'MODULE_NOT_FOUND' ) {
        throw e;
    }
    return console.error("Cannot find standard " + options["--standard"]);
}

processPath( path , function(path, data) {
    var report;
    if ( typeof options["--trace"] !== "undefined" ) {
        console.log( sniffer.trace(data, Standard) );
    } else {
        if ( report = sniffer.run( data, Standard ).report() ) {
            console.log( util.color("lightRed", "File: " + path + "\n") + report );
        } else {
            console.log( util.color("lightGreen", "File: " + path + " - OK ") );
        }
    }
});
